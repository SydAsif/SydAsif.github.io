---
layout: single
title:  "Python: Network Automation with Napalm"
date:   2022-07-03 15:02:15 +0500
categories: python
tags: 
  - automation
  - gns3
  - python
toc: true
toc_label: "On This Post"
toc_sticky: true
---

## [What is Napalm?](https://napalm.readthedocs.io/en/latest/index.html)
NAPALM (Network Automation and Programmability Abstraction Layer with Multi-vendor support) is a Python library that implements a set of functions to interact with different network device Operating Systems using a unified API. Unified API means the same code is used to configure multi-vendor devices.

_N.A.P.A.L.M_ is:

- Python library
- Open-source
- Unified API for multiple vendors
- Methods to manipulate configs
- Methods to retrieve data

### [Supported Network Operating Systems](https://napalm.readthedocs.io/en/latest/support/index.html)

It is used to interact with different hardware networking vendors. Basically, it works as an API on top of other APIs, adding another level of abstraction. Lately, many vendors have developed APIs to make it easier to interact with their equipment. For example, most of the JunOS devices support Juniper PyEZ, and so does Cisco’s Nexus with its NX-API.

- Arista EOS
- Cisco IOS
- Cisco IOS-XR
- Cisco NX-OS
- Juniper JunOS

### Installation

You can [install napalm with pip](https://napalm.readthedocs.io/en/latest/installation/index.html):

`pip install napalm`

That will install all the core drivers currently available.

We will use our previous topology as below:

![picture](/assets/images/network_automation.png)

[Lab Configuration](https://sydasif.github.io/python/telnetlib/#networkautomation-1-configuration) same as previous.

### Selecting the right driver

We can only specify what OS we are going to talk to and NAPALM will select the correct NetworkDriver. NetworkDriver is a library with all the functions related to that OS. You can select the driver you need by doing the following:

```py
# Import get_network_diver
from napalm import get_network_driver
'''Use the appropriate network driver to connect to the device.
The network driver is ios for cisco ios'''
get_network_driver('ios')
```

### Configuration support Method

- Config.replace
- Config.merge
- Commit Confirm
- Compare config
- Atomic Changes
- Rollback

The NAPALM library offers various methods we can invoke on a device object. Check them out in the [official docs](https://napalm.readthedocs.io/en/latest/base.html).

### [IOS Prerequisites](https://napalm.readthedocs.io/en/latest/support/ios.html)

IOS has no native API to play with, that’s the reason why _Napalm_ used the _Netmiko_ library to interact with it. Having Netmiko installed in your working box is a prerequisite.

#### Archive

IOSDriver requires that the archive functionality be enabled on IOS Device to perform auto-rollback on error. Make sure it’s enabled and set to a local filesystem _(for example ‘flash:’ or ‘bootflash:’)_.

```console
archive
  path flash:archive
  write-memory
```

#### Configuration file templet Requirments

- IOS requires a config file to begin with a version _eg. 15.0_ and _end_ marker at the end of the file. Otherwise, IOS will reject configure replace operation.
- For the diff to work properly, the indentation of your candidate file has to exactly match the indentation in the running-config.
- Finish blocks with ! as with the running-config, otherwise, some IOS versions might not be able to generate the diff properly.

#### SCP File Transfers

The NAPALM-ios driver requires SCP to be enabled on the managed device. SCP server functionality is disabled in IOS by default and is configured using _ip scp server enable_.

If an operation requiring a file transfer is attempted, but the necessary configuration is not present, a CommandErrorException will be raised.

### Programming samples

NAPALM tries to provide a standard interface and mechanisms to push configuration and retrieve state data from network devices. This method is very useful in combination with tools like Ansible, which in turn allows you to manage a set of devices independent of their network OS.

```py
from napalm import get_network_driver
# Connect to device.
driver = get_network_driver('ios')
# the device IP and password.
device = driver('192.168.10.11', 'admin', 'cisco') 
device.open()
# Get facts from device.
output = device.get_facts()
print(output)
# close the session with the device.
device.close()
```

#### Output from the Router

```console
root@NetworkAutomation-1:~# python3 02_napalm.py 
{'uptime': 660, 'vendor': 'Cisco', 'os_version': 'IOSv Software (VIOS-ADVENTERPRISEK9-M), Version 15.6(2)T, RELEASE SOFTWARE (fc2)', 'serial_number': '9HHI7QPAASZSJCJC1NC87', 'model': 'IOSv', 'hostname': 'R1', 'fqdn': 'R1.cisco.com', 'interface_list': ['GigabitEthernet0/0', 'GigabitEthernet0/1', 'GigabitEthernet0/2', 'GigabitEthernet0/3']}
```

> Import JSON to output a nicely formatted JSON object.

```py
import json
from napalm import get_network_driver

driver = get_network_driver('ios')
device = driver('192.168.10.10', 'admin', 'cisco')
device.open()

output = device.get_interfaces()
print(json.dumps(output, indent=4))

device.close()
```

##### The output is a nicely formatted

```console
root@NetworkAutomation-1:~# python3 03_napalm.py 
{
    "GigabitEthernet0/0": {
        "is_enabled": true,
        "is_up": true,
        "description": "",
        "mac_address": "0C:79:31:D9:00:00",
        "last_flapped": -1.0,
        "mtu": 1500,
        "speed": 100.0
    },
    "GigabitEthernet0/1": {
        "is_enabled": false,
        "is_up": false,
        "description": "",
        "mac_address": "0C:79:31:D9:00:01",
        "last_flapped": -1.0,
        "mtu": 1500,
        "speed": 1000.0
    },
    "GigabitEthernet0/2": {
        "is_enabled": false,
        "is_up": false,
        "description": "",
        "mac_address": "0C:79:31:D9:00:02",
        "last_flapped": -1.0,
        "mtu": 1500,
        "speed": 1000.0
    },
    "GigabitEthernet0/3": {
        "is_enabled": false,
        "is_up": false,
        "description": "",
        "mac_address": "0C:79:31:D9:00:03",
        "last_flapped": -1.0,
        "mtu": 1500,
        "speed": 1000.0
    }
}
```
